#!/usr/bin/env node

/**
 * Script para poblar eventos de gamificaci√≥n faltantes en producci√≥n
 * Crea eventos b√°sicos para usuarios que tienen perfiles pero no eventos
 */

import 'dotenv/config';
import { drizzle } from 'drizzle-orm/node-postgres';
import { Client } from 'pg';
import { gamificationProfiles, gamificationEvents, users } from './src/db/schema.ts';
import { eq } from 'drizzle-orm';

const client = new Client({
  connectionString: process.env.DATABASE_URL,
  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
});

async function populateGamificationEvents() {
  try {
    await client.connect();
    const db = drizzle(client);

    console.log('üîÑ Iniciando poblaci√≥n de eventos de gamificaci√≥n...');

    // Obtener todos los perfiles de gamificaci√≥n con sus UUIDs de usuario
    const profiles = await db.select({
      userId: gamificationProfiles.userId,
      walletAddress: gamificationProfiles.walletAddress,
      userUuid: users.id
    })
    .from(gamificationProfiles)
    .innerJoin(users, eq(gamificationProfiles.walletAddress, users.walletAddress));

    console.log(`üìä Encontrados ${profiles.length} perfiles de gamificaci√≥n con usuarios v√°lidos`);

    let eventsCreated = 0;

    for (const profile of profiles) {
      // Verificar si ya tiene eventos usando el UUID correcto
      const existingEvents = await db.select()
        .from(gamificationEvents)
        .where(eq(gamificationEvents.userId, profile.userUuid))
        .limit(1);

      if (existingEvents.length === 0) {
        // Crear evento de registro b√°sico
        console.log(`üìù Creando evento para usuario ${profile.userUuid} (wallet: ${profile.walletAddress})`);

        await db.insert(gamificationEvents).values({
          userId: profile.userUuid,
          type: 'user_registered',
          category: 'community',
          points: 20, // Puntos por registrarse
          metadata: {
            autoGenerated: true,
            reason: 'Migraci√≥n de producci√≥n - evento b√°sico'
          },
          createdAt: new Date(),
          processedAt: new Date()
        });

        // Tambi√©n crear un evento de daily login
        await db.insert(gamificationEvents).values({
          userId: profile.userUuid,
          type: 'daily_login',
          category: 'daily',
          points: 10, // Puntos por login diario
          metadata: {
            autoGenerated: true,
            reason: 'Migraci√≥n de producci√≥n - primer login'
          },
          createdAt: new Date(),
          processedAt: new Date()
        });

        eventsCreated += 2;
      } else {
        console.log(`‚ÑπÔ∏è Usuario ${profile.userUuid} ya tiene eventos`);
      }
    }

    console.log(`‚úÖ Proceso completado. Eventos creados: ${eventsCreated}`);

    // Verificar el resultado
    const totalEvents = await db.$count(gamificationEvents);
    console.log(`üìä Total de eventos en la base de datos: ${totalEvents}`);

    client.end();
  } catch (err) {
    console.error('‚ùå Error:', err);
    process.exit(1);
  }
}

populateGamificationEvents();
